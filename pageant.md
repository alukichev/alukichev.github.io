# Pageant and the three SSH clients
Sometimes you _have to_ work on Windows, which may include using SSH either directly or via other programs like git and VSCode. There are several popular software packages that provide you with SSH communication. What I know and use are:
- Microsoft’s port of OpenSSH (fresher [preview releases](https://github.com/PowerShell/Win32-OpenSSH/releases), older [official images](https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse?tabs=powershell&pivots=windows-11#install-openssh-server--client));
- build of openssh that comes with [Git for Windows](https://git-scm.com/install/windows);
- openssh [package](https://packages.msys2.org/base/openssh) in [MSYS2](https://www.msys2.org/) distribution.

Out of the three, the last one has the highest chance of being the latest released version from [upstream](https://www.openssh.org/portable.html). It and the second option are probably slower than the first one because they use a POSIX emulation layer, `msys-2.0.dll` (although I haven't been able to observe slowness in practice). The first option has fully native Windows tools, ported with some design changes.

That also serves as one reason for this post: differences between MS and the other two versions of openssh sometimes result in hours of finding a solution to unexpected behavior. Some of that effort may (or may not) be spared by my experience shared here.

Both SSH client and server need to prove their identities. Clients may do that in different ways, and public key authentication is a popular method. It involves operations with a private key that is often encrypted with a user-provided passphrase. A program that decrypts the key once and then lets different SSH clients use it during run time is called "SSH agent". It boosts productivity as you don't have to enter your passphrase for each new SSH conection but only the first time (or after some expiration period that you can define).

There are many programs that can act as an agent, every popular SSH package comes with one. If you have several of them installed, making them use only one SSH agent can be tricky. This post is about using PuTTY’s authentication agent, [Pageant](https://the.earth.li/~sgtatham/putty/0.83/htmldoc/Chapter9.html#pageant), with the three SSH packages listed above.

Making `ssh/scp/sftp` and `ssh-add` from each of them successfully find Pageant has a problem: every package differs slightly in where to keep configuration and how to contact an agent.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Contents**

1. [Why Pageant](#why-pageant)
1. [MS OpenSSH](#ms-openssh)
   1. [`SSH_AUTH_SOCK` environment variable](#ssh_auth_sock-environment-variable)
   1. [Autogenerated `IdentityAgent`](#autogenerated-identityagent)
1. [ssh in "Git Bash"](#ssh-in-git-bash)
   1. [MS SSH tools will mix an MSYS agent up](#ms-ssh-tools-will-mix-an-msys-agent-up)
   1. [One config for both MS and Git ssh](#one-config-for-both-ms-and-git-ssh)
      1. [Several Windows users](#several-windows-users)
1. [MSYS2 openssh](#msys2-openssh)
   1. [If you don't have admin rights](#if-you-dont-have-admin-rights)
1. [Start Pageant at logon](#start-pageant-at-logon)
1. [Links](#links)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Why Pageant
While Microsoft’s port of OpenSSH has an agent, their idea of how to use it may not be what you really want if your keys are passphrase-protected. After initial decryption with a passphrase, MS `ssh-agent.exe` re-encrypts the key using your user session credentials and stores it permanently in System Registry (`HKCU\Software\OpenSSH\Agent\Keys`). Thereafter (even after a reboot), the key is accessible without a passphrase by any process that talks to the agent in your user session. Such a design looks convenient, but you could store your keys in plain text just as well, relying only on file access permissions. [Here](https://github.com/PowerShell/Win32-OpenSSH/issues/1487#issuecomment-547798640) is a more detailed explanation of the issue and the vendor's ~~prompt reaction~~.

Pageant is closer to the traditional OpenSSH behavior in that regard: it lets you retain passphrase protection of your keys. It is a native Windows application, in contrast to MSYS-based agents. It comes from a widely-used project that has been around for many years and is still actively maintained. PuTTY-provided SSH can be used by many other Windows-based applications, so it seems a good idea to use Pageant to keep your secret keys.

As with any program that deals with security, especially on Windows, there are still [considerations](https://winscp.net/eng/docs/ui_pageant#security_considerations) to be aware of.

## MS OpenSSH
Microsoft port of OpenSSH uses native Windows named pipes to talk to an agent. Pageant also: it creates a uniquely named pipe upon start and talks the same protocol as MS SSH tools. You can get the pipe name, e.g., in Powershell with `(Get-ChildItem \\.\pipe\).FullName | Where { $_ -match "pageant" }` (there should be only one).

### `SSH_AUTH_SOCK` environment variable
If you put the pipe name into `SSH_AUTH_SOCK` environment variable, then `ssh-add.exe`, `ssh/scp/sftp.exe` from the package will be able to communicate with Pageant using it. E.g., as in this Powershell session:

```PowerShell
❯ pageant .ssh/alukichev.ppk
❯ ssh-add -l
The agent has no identities.
❯ scp alukichev@my-linux-box:tmp/some.tar.gz .
Enter passphrase for key 'C:\Users\alukichev/.ssh/alukichev-win64.priv':^C
C:\Program Files\OpenSSH\scp.exe: Connection closed
❯ $env:SSH_AUTH_SOCK = "\\.\pipe\pageant.a.lukichev.0b85d0b2bcb2dd1a785d490f40a4670c6a186d70771fb32dadb1515ed2235078"
❯ ssh-add -l
256 SHA256:ylOyyJIDCM9HyjZM9EZksOeFMcTjkPh1pMeMLqJ4UvU alukichev-win64-eddsa-key (ED25519)
❯ scp alukichev@my-linux-box:tmp/some.tar.gz .
some.tar.gz                              100% 1911KB   4.2MB/s   00:00
```

The pipe name is supposed to stay the same across sessions of the same user, at least for now (proof: [1](https://git.tartarus.org/?p=simon/putty.git;a=blob;f=windows/utils/agent_named_pipe_name.c;h=aa64b3f60df455e06d6bc1b6c47923143b7a2dda;hb=HEAD#l12), [2](https://git.tartarus.org/?p=simon/putty.git;a=blob;f=windows/utils/cryptoapi.c;h=c3752c59dd13ab6a0848ee02ce1a40934f9bacb2;hb=HEAD#l29)). You may want to employ that circumstance and set `SSH_AUTH_SOCK` permanently with the name discovered from a running Pageant process:

```PowerShell
❯ $env:SSH_AUTH_SOCK = (Get-ChildItem \\.\pipe\).FullName | Where { $_ -match "pageant" }
❯ $env:SSH_AUTH_SOCK
\\.\pipe\pageant.a.lukichev.0b85d0b2bcb2dd1a785d490f40a4670c6a186d70771fb32dadb1515ed2235078
❯ reg add HKCU\Environment /v SSH_AUTH_SOCK /t REG_SZ /d $env:SSH_AUTH_SOCK /f
The operation completed successfully.
```

After that, MS SSH tools will be able to contact Pageant if it is running. However, take care to override the value of that variable within Git bash and MSYS2 environments if you use their ssh packages. They don't understand Windows pipes.

The trick here relies on current implementation of how the Pageant pipe gets its name and may eventually stop working. Officially recommended way to get the pipe name is with the `--openssh-config` command line option.

### Autogenerated `IdentityAgent`
Pageant can generate a file that you can include in your `%USERPROFILE%\.ssh\config` and avoid setting the `SSH_AUTH_SOCK` variable. `ssh.exe`, `scp.exe` and `sftp.exe` will work with that approach, but not `ssh-add.exe`.

Start Pageant with `--openssh-config` command line option, e.g. (in Powershell),

```PowerShell
❯ pageant --openssh-config .ssh/pageant.conf .ssh/alukichev.ppk
```

Then put the generated file into your `.ssh/config`:

```txt
Host *
    Include pageant.conf
```

## ssh in "Git Bash"
Git for Windows comes in an MSYS2-based distribution and is bundled with MSYS flavor of OpenSSH [upstream](https://www.openssh.org/portable.html) (not Microsoft’s) package. Its behavior is the same as on other platforms. Consequently, it does not know about Windows native mechanisms such as named pipes and cannot speak with Pageant the same way as MS OpenSSH does.

Luckily, Git for Windows comes with an [adapter](https://github.com/cuviper/ssh-pageant) that can help you. Add these lines into your `$HOME/.bash_profile` file:

```bash
# Set up SSH agent
eval $(ssh-pageant -r -a $HOME/.ssh/ssh-pageant.sock)
```

(check where your `$HOME` points to in Windows by running `cygpath -w $HOME` in "git bash" prompt and ensure there is an `.ssh` directory there).

The adapter will check if there is an AF_UNIX socket at the specified path. If there is none, it will create one and start listening on it. If there is already a socket, it will simply exit. In any case, it will output at least `SSH_AUTH_SOCK=<your-home>/.ssh/ssh-pageant.sock; export SSH_AUTH_SOCK;` to standard output, so `eval` command can interpret that and set the variable when you start a "git bash" session.

### MS SSH tools will mix an MSYS agent up
Be aware that MS OpenSSH tools try to use whatever is in `SSH_AUTH_SOCK` as a native Windows named pipe. Consequently, they seem to mix up the other end if the channel is not a pipe but an AF_UNIX socket. Whether it's the `ssh-pageant` adapter or a true non_MS `ssh-agent`, you'll have to restart it after the mix-up.

```log
alukichev@MACHINE MINGW64 ~
$ echo $SSH_AUTH_SOCK
/c/Users/alukichev/.ssh/ssh-pageant.sock

alukichev@MACHINE MINGW64 ~
$ ssh-add -l
256 SHA256:ylOyyJIDCM9HyjZM9EZksOeFMcTjkPh1pMeMLqJ4UvU alukichev-win64-eddsa-key (ED25519)

alukichev@MACHINE MINGW64 ~
$ /c/Program\ Files/OpenSSH/ssh-add -l
error fetching identities: invalid format

alukichev@MACHINE MINGW64 ~
$ ssh-add -l
Error connecting to agent: Bad file descriptor
```

If you prefer to use the MSYS openssh inside "Git Bash" environment, then make sure your `PATH` variable there finds it instead of the MS SSH tools. For instance, run `which ssh | grep -q /c/ && echo Oh no\!`. If that produces no output, then it should be fine. If it says "Oh no!", then scan your `.bash_profile`, `.bashrc`, `/etc/profile`, `/etc/profile.d/*` and `/etc/bash.bashrc` files for commands that modify `PATH` variable and make sure that the resulting value for your session doesn’t have MS OpenSSH installation in front of `/usr/bin`.

### One config for both MS and Git ssh
Git MSYS environment considers the path in `%USERPROFILE%` as user’s `HOME` (unless you add/modify the variable in Windows and/or modify the `db_home:` entry in `/etc/nsswitch.conf`).

That means that if you have MS OpenSSH and have set `IdentityAgent` in your `$HOME/.ssh/config` file to a named pipe of Pageant, then your Git `ssh/scp/sftp` tools will try to use that as a channel to an agent. However, they don’t understand how to open a pipe and will refuse to speak to Pageant: you can see a `debug1: get_agent_identities: ssh_get_authentication_socket: No such file or directory` message if you run them with `-v` option.

If you want to keep your configuration in the same file and still use both MS and Git ssh, then you have to specify that only differing part (how to talk to Pageant) in a vendor-specific place. Put the following lines into `C:\ProgramData\ssh\ssh_config` file (create one if it does not exist):

```txt
Host *
    Include c:/Users/<your-username>/.ssh/pageant.conf
```

Then remove the `Include pageant.conf` string from your now-common `$HOME/.ssh/config` file.

After that, MS SSH tools will be using the `.ssh/config` plus the one in `C:\ProgramData\ssh\ssh_config` which includes the `.ssh/pageant.conf`. Git SSH tools will be using only the `.ssh/config`. Both will find Pageant in their own ways.

#### Several Windows users

Unfortunately, using environment variables like `%USERPROFILE%` or shortcuts like `~` in `C:\ProgramData\ssh\ssh_config` is not supported by MS OpenSSH.

If you don’t want to hard-code the `pageant.conf` path to a specific username but rather want MS SSH to _try_ including that file from _current user’s_ profile directory, then you can map the `%USERPROFILE%` of current user to a drive and use that drive instead.

For instance, run the command `subst h: %USERPROFILE%` at log on and then change the path in your `C:\ProgramData\ssh\ssh_config`:

```txt
Host *
    Include h:/.ssh/pageant.conf
```

## MSYS2 openssh
If you have [MSYS2](https://www.msys2.org/) and have installed [openssh](https://packages.msys2.org/base/openssh) (`pacman -S openssh`), then its binaries may assume `/home/$USER` as your home directory, regardless what is set in the `HOME` environment variable. If that is the case and if you want to keep the single config for all SSH programs you use, then create a symbolic link in `/home/$USER/.ssh` that points to `$USERPROFILE/.ssh`. Open the MSYS prompt _as administrator_ and run

```log
# [[ -d /home/$USER/.ssh ]] && mv /home/$USER/.ssh{,.orig}
# MSYS=winsymlinks:nativestrict ln -s $USERPROFILE/.ssh /home/$USER/
```

Setting `MSYS` environment variable for `ln` command is needed because by default it copies files instead of linking them on Windows. Admin privileges are needed because creating links on an NTFS volume may be blocked for ordinary users by Windows security policy.

Now your MSYS2 openssh binaries will use the common config and other data (e.g., `known_hosts`) in your Windows profile directory.

Setting up communication with Pageant as well as avoiding inclusion of `pageant.conf` works the same way as in the case of Git for Windows.

### If you don't have admin rights
Alternatively, if you have a problem getting Admin rights on your Windows machine, create a "dummy" config which includes the one in `$USERPROFILE/.ssh`:

```log
alukichev@MACHINE MSYS ~
$ mkdir /home/$USER/.ssh && echo "Include ~/.ssh/config" >/home/$USER/.ssh/config

alukichev@MACHINE MSYS ~
$ cat /home/$USER/.ssh/config
Include ~/.ssh/config
```

Curiously, MSYS2 openssh binaries interpret environment variables and `~` correctly while reading configuration. They just start searching for user config at a hard-coded path.

The small limitation of this approach is that `known_hosts` will still be kept separately in `/home/$USER` by `ssh/scp/sftp`. However, that is not even a nuisance for most use cases.

## Start Pageant at logon
To start Pageant and load keys every time you log on to your Windows, set it up as a task in Task Scheduler (`taskschd.msc`). Start it and choose "Create Task...". Then in the dialog, set:

- Name: Pageant
- Run only when user is logged on
- Triggers → New...
  - Begin the task: At log on
  - Advanced settings: all unset except "Enabled"
- Actions → New...
  - Action: Start a program
  - Program/script: `"C:\Program Files\PuTTY\pageant.exe"` (or the location where you have it installed, use quotes if the path contains spaces)
  - Add arguments: `--openssh-config %USERPROFILE%\.ssh\pageant.conf %USERPROFILE%\.ssh\your-key.ppk`
    - Add as many keys as you want loaded
- Conditions
  - Make sure all of them, including the disabled "Stop if computer ceases to be idle", are unset
    - If that particular condition is set, even if disabled, you risk your Pageant killed every time your computer wakes up from sleep
- Settings
  - Allow the task to be run on demand

## Links
1. Pageant manual, [v0.83](https://the.earth.li/~sgtatham/putty/0.83/htmldoc/Chapter9.html#pageant).
1. Pageant [source code](https://git.tartarus.org/?p=simon/putty.git;a=summary).
1. Article "[Using Pageant for Authentication](https://winscp.net/eng/docs/ui_pageant)" on winscp with many tips and ideas.
1. [Guide](https://gitforwindows.org/openssh-integration-with-pageant.html) to use Pageant with Git fo Windows, on a project's website. The guide utilizes a [fancier script](https://github.com/git-for-windows/git-sdk-64/blob/cde48534f2bf352036b6e76ab361adb61bdd3d8f/cmd/start-ssh-pageant.cmd) to start the `ssh-pageant` adapter and assumes no other openssh package installed alongside.
1. Why is MSYS-based openssh [supposed to be slower](https://gitforwindows.org/the-difference-between-mingw-and-msys2.html#difference-between-msys2-and-mingw-going-into-details) on Windows.
1. [How it looks](https://wiki.archlinux.org/title/SSH_keys#SSH_agents) like on Linux with agents, ArchLinux wiki.
1. MS OpenSSH [source code](https://github.com/PowerShell/openssh-portable), see `contrib/win32/win32compat` for Windows-specific code.
1. Manuals: [ssh](https://man.archlinux.org/man/ssh.1.en), [ssh_config](https://man.archlinux.org/man/ssh_config.5.en).
